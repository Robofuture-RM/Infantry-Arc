### 软件环境

- Toolchain/IDE : STM32CubeIDE
- package version: STM32Cube FW_F4 V1.25.2
- FreeRTOS version: 10.3.1
- CMSIS-RTOS version: 1.02

### 硬件接线与机械安装

硬件接线采用下图方式：

![RM步兵布线图](.\Doc\RM步兵布线图.png)

麦轮安装采用O型安装。

### 程序说明

#### 程序框架

程序采用`FreeRTOS`操作系统，有一套BSP完成底层IO的驱动。其他文件夹如下：

Application：应用程序，包括系统任务；

BSP：开发板C型底层IO驱动程序；

Components：程序使用到的组件，包括算法、驱动；

Core：使用CubeMX软件生成的相关驱动；

Doc：文档；

Drivers：HAL库；

Middlewares：FreeRTOS灯第三方提供驱动包。

主控采用大疆开发板C型，通过短接PB12，进行云台与底盘程序的选择。

### 通讯协议

通讯协议格式在[裁判系统协议](https://github.com/RoboMaster/referee_serial_port_protocol)上进行添加。

通信数据主要分为类：

1. 各电机控制数据
2. 底盘与裁判系统交互数据
3. 云台主控与底盘主控交互数据
4. pc与云台主控交互数据（未完成）

### 警报与LED指示灯

我们可以通过蜂鸣器与LED的现象来快速判断出现何种问题，当上电后会听到两次“嘀-嘀-嘀-”，第一次代表底盘主控启动，第二次代表云台主控启动，正常运行时绿灯常亮。

（注意区分是那个主控发出警报声）

#### 云台主控

| LED效果 | 蜂鸣器音效 | 原因                      | 排故                               |
| :------ | :--------- | :------------------------ | ---------------------------------- |
| 绿      | 无         | 运行正常                  | 无                                 |
| 黄      | 无         | 遥控未连接                | 检查遥控是否打开；DR16接收器连接； |
| 黄      | 一次       | 未收到裁判系统串口数据    | 检查CAN1连接                       |
| 黄      | 两次       | 未收到底盘主控数据        | 检查CAN1连接                       |
| 红      | 一次       | 未收到左摩擦轮电机数据    | 检查左摩擦轮电机CAN线              |
| 红      | 两次       | 未收到右摩擦轮电机数据    | 检查右摩擦轮电机CAN线              |
| 红      | 三次       | 未收到拨弹电机数据        | 检查拨弹电机CAN线                  |
| 红      | 四次       | 未收到弹仓盖电机数据      | 检查弹仓盖电机CAN线                |
| 红      | 五次       | 未收到Pitch轴云台电机数据 | 检查Pitch轴云台电机CAN线           |
| 红      | 六次       | 未收到Yaw轴云台电机数据   | 检查Yaw轴云台电机CAN线             |

#### 底盘主控

| LED效果 | 蜂鸣器音效 | 原因                   | 排故                               |
| :------ | :--------- | :--------------------- | ---------------------------------- |
| 绿      | 无         | 运行正常               | 无                                 |
| 黄      | 无         | 遥控未连接             | 检查遥控是否打开；DR16接收器连接； |
| 黄      | 一次       | 未收到裁判系统串口数据 | 检查裁判系统串口线                 |
| 黄      | 三次       | 未收到云台主控数据     | 检查CAN1连接                       |
| 红      | 一次       | 未收到左前轮电机数据   | 检查左前轮电机CAN线                |
| 红      | 两次       | 未收到右前轮电机数据   | 检查右前轮电机CAN线                |
| 红      | 三次       | 未收到左后轮电机数据   | 检查左后轮电机CAN线                |
| 红      | 四次       | 未收到右后轮电机数据   | 检查右后轮电机CAN线                |

### 操控说明

遥控说明：

![遥控说明](.\Doc\遥控说明.jpg)

遥控操作：

将S2拨杆打到中间，进入遥控控制模式。左摇杆控制云台运动，右摇杆控制底盘运动。S1拨杆处于中，底盘跟随云台方向；S1拨杆处于下，底盘开始自旋（陀螺）运动；S1拨杆处于上，底盘与云台分别控制；拨轮推上，进入射击状态；拨轮拉下，发射一颗子弹，保持1秒后，持续发射。

键盘鼠标控制：

连接遥控器与电脑，打开RoboMaster Client软件，将S2拨杆打到上，进入键盘鼠标控制。鼠标控制云台运动；W、A、S、D控制小车前后左右移动，按住Shift会提高移动速度；V开启摩擦轮，进入射击模式；鼠标左键发射一颗子弹；鼠标右键5连发

自动控制：（暂不支持）

将S2拨杆打到下。